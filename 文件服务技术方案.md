# 文件服务技术方案

```
李展发 Modified November 13
```
## 背景

#### 由于各个服务如笔记服务、点评服务等都有保存图片的需求。因此我们新增一个 服

务用于统一管理文件。由该服务直接管理 MinIO 并暴露文件管理接口供其它服务使用。

## 核心功能

#### 我们需要提供以下功能：

#### 1. 支持临时文件保存（ 7 天有效期，过期自动删除）

#### 2. 支持永久文件保存

```
3. 申请一个上传签名 url 用于上传文件
a. 需要支持临时文件上传
b. 需要支持永久文件上传
4. 批量获取文件的签名下载 url
5. 复制文件
6. 删除文件
7. 临时文件从临时bucket中移动到永久bucket下
```
## 文件路径规则

为了支持临时文件保存，我们使用两个 bucket：

```
1. temp bucket：retain policy 为 7 天，超过 7 天的文件自动删除，用于保存临时文件
2. permanent bucket：retain policy 无限期，用于保存永久文件
```
#### 通用的文件路径如下： ，其意义如下：

```
1. bucket：保存的 bucket，取值为 temp 或 permanent
2. service：文件归属的服务
```

```
3. file-path：图片的具体路径
```
## 接口设计

#### 对于一个文件资源，我们设计以下通用结构：

```
Code block
```
## 接口设计

### GetUploadSignedUrl

#### 此 RPC 接口用于获取永久文件的签名 URL，用来给前端上传一个永久文件。

```
Code block
```

### GetTempUploadSignedUrl

此 RPC 接口用于获取一个签名 URL，用来给前端上传一个临时文件。参数与 GetUploadSignedUrl 的
相同。

### GetDownloadSignedUrls

#### 此接口用于获取一批文件的签名 URL，用于前端展示文件。

```
Code block
```
### CopyFiles

#### 此接口用于将一批文件复制到新的位置。

```
Code block
```

### DeleteFiles

#### 此接口用于删除一个或多个文件：

```
Code block
```
### CopyToPermanent

此接口用于将文件从临时文件 bucket 复制到永久文件 bucket。

```
Code block
```
- 当传入的文件本身已经在永久 bucket 中，会被直接忽略^
- 由于调用方在调用完此接口后，还需要将新的文件对象数组保存回数据库。此过程可能发生错
    误，因此复制后的文件不会被立刻被删除，以便调用方可以重试。

## 场景示例

### 用户保存笔记草稿，其中附有图片



