networks:
  default:
    name: tripsphere
    driver: bridge

services:
  # Nacos
  nacos:
    image: nacos/nacos-server:v2.5.1
    container_name: nacos
    environment:
      - PREFER_HOST_MODE=hostname
      - MODE=standalone
    ports:
      - "8848:8848"
      - "9848:9848"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8848/nacos/v1/console/health/liveness || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 90s

  # MinIO
  minio:
    container_name: minio
    image: minio/minio:RELEASE.2024-12-18T13-15-44Z
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    ports:
      - "9001:9001"
      - "9000:9000"
    volumes:
      - ${DOCKER_VOLUME_DIRECTORY:-/tmp/docker}/volumes/minio:/minio_data
    command: minio server /minio_data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Trip File Service
  trip-file-service:
    build:
      context: .
      dockerfile: Dockerfile
    image: trip-file-service:latest
    container_name: trip-file-service
    ports:
      - "50051:50051"
    environment:
      - APP_ENV=dev
      - APP_NAME=trip-file-service
      - PORT=50051
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - NACOS_NAMESPACE=public
      - NACOS_GROUP=DEFAULT_GROUP
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
    depends_on:
      nacos:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "50051"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # Register MinIO to Nacos
  nacos-register-minio:
    image: curlimages/curl:latest
    container_name: nacos-register-minio
    depends_on:
      nacos:
        condition: service_healthy
      minio:
        condition: service_healthy
    restart: "no"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "curl -X POST 'http://nacos:8848/nacos/v1/ns/instance?serviceName=minio&ip=minio&port=9000&ephemeral=false' && echo 'MinIO registered successfully!'"
